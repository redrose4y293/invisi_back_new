generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

enum Role {
  admin
  dealer
  installer
  marketing
  user
}

enum PageStatus {
  draft
  published
}

enum InstallStatus {
  created
  scheduled
  in_progress
  completed
  archived
}

model User {
  id           String       @id @default(auto()) @map("_id") @db.ObjectId
  email        String       @unique
  passwordHash String
  displayName  String
  roles        Role[]
  profile      Json?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  deletedAt    DateTime?
  sessions     Session[]
  uploads      UploadAsset[] @relation("UserUploads")
  pagesCreated Page[]        @relation("PagesCreated")
  pagesUpdated Page[]        @relation("PagesUpdated")
  auditEvents  AuditEvent[]  @relation("AuditActor")
}

model Session {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  user         User     @relation(fields: [userId], references: [id])
  userId       String   @db.ObjectId
  refreshToken String
  userAgent    String?
  ip           String?
  createdAt    DateTime @default(now())
  revokedAt    DateTime?
}

model Page {
  id          String     @id @default(auto()) @map("_id") @db.ObjectId
  title       String
  slug        String     @unique
  body        String
  status      PageStatus @default(draft)
  meta        Json?
  createdBy   User       @relation("PagesCreated", fields: [createdById], references: [id])
  createdById String     @db.ObjectId
  updatedBy   User?      @relation("PagesUpdated", fields: [updatedById], references: [id])
  updatedById String?    @db.ObjectId
  publishedAt DateTime?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
}

model UploadAsset {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  objectKey   String   @unique
  contentType String
  size        Int
  publicUrl   String?
  context     String?
  uploader    User?    @relation("UserUploads", fields: [uploaderId], references: [id])
  uploaderId  String?  @db.ObjectId
  createdAt   DateTime @default(now())
}

model Installation {
  id            String        @id @default(auto()) @map("_id") @db.ObjectId
  dealerId      String?       @db.ObjectId
  siteName      String
  address       Json?
  customerInfo  Json?
  scheduledAt   DateTime?
  status        InstallStatus @default(created)
  notes         String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  reports       Report[]
}

model Report {
  id              String        @id @default(auto()) @map("_id") @db.ObjectId
  installation    Installation  @relation(fields: [installationId], references: [id])
  installationId  String        @db.ObjectId
  reportType      String
  notes           String?
  uploadObjectKey String
  createdAt       DateTime      @default(now())
}

model AuditEvent {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  actorId   String?  @db.ObjectId
  actor     User?    @relation("AuditActor", fields: [actorId], references: [id])
  action    String
  target    String?
  meta      Json?
  createdAt DateTime @default(now())
}

// Leads management
enum LeadStatus {
  New
  In_Review
  Qualified
  Closed
}

enum LeadType {
  Prototype
  Dealer
  Media
  Other
}

model Lead {
  id        String     @id @default(auto()) @map("_id") @db.ObjectId
  name      String
  email     String
  phone     String?
  company   String?
  country   String?
  type      LeadType
  message   String?
  tags      String[]
  status    LeadStatus  @default(New)
  owner     String?
  createdAt DateTime    @default(now())
}

enum DealerStatus {
  Pending
  Active
  Suspended
}

model Dealer {
  id           String       @id @default(auto()) @map("_id") @db.ObjectId
  org          String
  contactName  String
  contactEmail String
  region       String
  status       DealerStatus @default(Pending)
  users        Int          @default(0)
  last         DateTime     @default(now())
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
}

enum FileType {
  PDF
  Video
  Image
  Other
}

enum FileVisibility {
  Public
  Dealer
  Admin
}

enum FileCategory {
  NDA
  Spec
  Report
  Marketing
}

model FileAsset {
  id        String        @id @default(auto()) @map("_id") @db.ObjectId
  name      String
  type      FileType
  cat       FileCategory
  vis       FileVisibility
  url       String
  desc      String?
  size      Int?
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
}

enum ProductStatus {
  Draft
  Live
  Archived
}

model Product {
  id        String         @id @default(auto()) @map("_id") @db.ObjectId
  name      String
  code      String?
  variant   String?
  short     String?
  long      String?
  bullets   String?
  nij       String?
  thickness String?
  vlt       String?
  impact    String?
  images    String[]
  datasheet String?
  slug      String        @unique
  metaTitle String?
  metaDesc  String?
  status    ProductStatus @default(Draft)
  updatedAt DateTime      @updatedAt
  createdAt DateTime      @default(now())
}

// Dealer uploads & Trainings
enum DealerUploadStatus {
  Pending
  Approved
  Rejected
}

model DealerUpload {
  id          String              @id @default(auto()) @map("_id") @db.ObjectId
  userId      String              @db.ObjectId
  email       String
  name        String
  category    String
  description String?
  status      DealerUploadStatus  @default(Pending)
  reviewerId  String?             @db.ObjectId
  reviewNote  String?
  createdAt   DateTime            @default(now())
  reviewedAt  DateTime?
}

enum TrainingMode {
  Online
  On_site
}

enum TrainingStatus {
  Draft
  Live
  Archived
}

model TrainingEvent {
  id        String          @id @default(auto()) @map("_id") @db.ObjectId
  title     String
  datetime  DateTime
  mode      TrainingMode
  location  String?
  desc      String?
  status    TrainingStatus  @default(Live)
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt
}

model TrainingRegistration {
  id        String         @id @default(auto()) @map("_id") @db.ObjectId
  eventId   String         @db.ObjectId
  userId    String         @db.ObjectId
  note      String?
  status    String         @default("Registered")
  createdAt DateTime       @default(now())
}
